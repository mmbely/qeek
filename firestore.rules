rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return request.auth.uid == 'RnInDl1twWVwyWWMcEkB1sETtoq1';
    }
    
    function getAccount(accountId) {
      return get(/databases/$(database)/documents/accounts/$(accountId));
    }
    
    function isAccountMember(accountId) {
      let account = getAccount(accountId);
      return isSignedIn() && 
        exists(/databases/$(database)/documents/accounts/$(accountId)) &&
        (account.data.members[request.auth.uid] != null || 
         request.auth.uid == accountId);
    }
    
    function isTicketInAccount(ticketData) {
      return isAccountMember(ticketData.accountId);
    }

    match /tickets/{ticketId} {
      allow read: if isTicketInAccount(resource.data);
      allow create: if isTicketInAccount(request.resource.data);
      allow update: if isTicketInAccount(resource.data) && 
                      isTicketInAccount(request.resource.data) &&
                      resource.data.accountId == request.resource.data.accountId;
      allow delete: if isTicketInAccount(resource.data);
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && 
        request.auth.uid == userId;
      allow delete: if isSignedIn() && 
        request.auth.uid == userId;
    }

    match /accounts/{accountId} {
      allow read: if isSignedIn() && 
        (resource.data.members[request.auth.uid] != null || 
         request.auth.uid == accountId);
      allow create: if isSignedIn() && 
        accountId == request.auth.uid &&
        request.resource.data.members[request.auth.uid] != null &&
        request.resource.data.members[request.auth.uid].role == "owner" &&
        request.resource.data.ownerId == request.auth.uid;
    }

    match /messages/{messageId} {
      function isMessageParticipant() {
        let msg = resource.data;
        return isSignedIn() && (
          (msg.participants != null && request.auth.uid in msg.participants) ||
          (msg.channelId.split('_')[0] == 'dm' && 
           (request.auth.uid == msg.channelId.split('_')[1] || 
            request.auth.uid == msg.channelId.split('_')[2])) ||
          (msg.accountId != null && isAccountMember(msg.accountId))
        );
      }

      allow read: if isSignedIn() && (
        resource.data.participants != null && request.auth.uid in resource.data.participants ||
        resource.data.accountId != null && isAccountMember(resource.data.accountId)
      );
      
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid &&
        (
          // For DM channels
          (request.resource.data.channelId.matches('^dm_.*') && 
           (request.resource.data.participants == null || 
            request.auth.uid in request.resource.data.participants)) ||
          // For general channel
          (!request.resource.data.channelId.matches('^dm_.*') && 
           isAccountMember(request.resource.data.accountId))
        );

      allow update: if isSignedIn() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;
        
      allow delete: if false;  // Explicitly deny message deletion
    }

    match /repositories/{repoId} {
      // Allow read/write if user is super admin
      allow read, write: if isSuperAdmin();
      
      // Regular user access
      allow read: if isSignedIn() && (
        !('accountId' in resource.data) ||
        resource.data.accountId == null ||
        isAccountMember(resource.data.accountId)
      );
      
      match /files/{fileId} {
        allow read, write: if isSuperAdmin();
        
        // Regular user access
        allow read: if isSignedIn() && (
          !('accountId' in get(/databases/$(database)/documents/repositories/$(repoId)).data) ||
          get(/databases/$(database)/documents/repositories/$(repoId)).data.accountId == null ||
          isAccountMember(get(/databases/$(database)/documents/repositories/$(repoId)).data.accountId)
        );
      }
    }

    match /secure_tokens/{tokenId} {
      allow read: if isSignedIn() && (
        request.auth.uid == tokenId || 
        isAccountMember(tokenId) ||
        tokenId == request.auth.uid
      );
      // Only allow write through Cloud Functions
      allow write: if false;
    }
  }
}